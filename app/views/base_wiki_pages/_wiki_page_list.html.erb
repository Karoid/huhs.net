<link rel="stylesheet" href="/css/board.css">
<!--게시글 목록 시작-->
<table class="table table-hover article_list" style="max-width: 950px; margin: 0 auto;">
  <thead>
    <tr style="font-size: 20px;">
      <td class="th" style="text-align: left;">#</td>
      <td class="th" style="font-weight: bolder;text-align: left;">제목</td>
      <td class="th">바꾼이</td>
      <td class="th">최근 수정</td>
      <td style="font-size:15px;line-height:35px;border-bottom: 1px solid #000000;text-align:center"><span class="glyphicon glyphicon-eye-open" aria-hidden="true"></span></td>
    </tr>
  </thead>
  <tbody>
    <% @pages.each do |article|%>
    <tr>
      <td class="td_number" scope="row"><%=article.id%></th>
      <td class="td_title"><%= link_to article.title, wiki_page_path( article ) %></td>
      <td class="td_name"><%=Member.find(article.updator_id).username%></td>
      <td class="td_date"><span class='hidden-xs'><%=article.updated_at.strftime("%Y.")%></span><%=article.updated_at.strftime("%m.%d")%></td>
      <td class="td_page_view"><%=Statistic.where(name: "read_article",target_model:WikiPage, target_id: article.id).length%></td>
    </tr>
    <%end%>
  </tbody>
</table>

<center>
<nav>
<%= will_paginate @pages , previous_label: "◀", next_label: "▶" %>
</nav>
</center>

<script>
  /* 모바일 무한 스크롤 */
var page = parseInt($("nav div em").html())

$(document).scroll(function() {
    if (Math.round($(document).scrollTop()) >= $("#article").height() - $(window).height()+89) {
      page+=1
loading = $('<div id="loading" class="load" style="display: none;"><span><img src="http://www.downgraf.com/wp-content/uploads/2014/09/01-progress.gif" alt="cargando..."/></span></div>');
$('table.article_list').after(loading);
loading.fadeIn();
$.ajax({
  type: 'GET',
  url: window.location.href + "?page="+page,
  dataType: 'json',
  data: {json:true},
  success: (function(data) {
    return loading.fadeOut(function() {
      var html = ""
      $.each(data,function(index, article) {
        var datetime = new Date(article.created_at)
        console.log(article)
        html += '<tr>'+
        '<td class="td_number" scope="row">'+article.id+'</th>'+
        '<td class="td_title"><a href="/wiki/'+window.location.pathname.split("/")[2]+'">'+article.title+'</a></td>'+
        '<td class="td_name">'+article.member_name+'</td>'+
        '<td class="td_date"><span class="hidden-xs">'+datetime.getFullYear()+'.</span>'+datetime.getMonth()+"."+datetime.getDate()+'</td>'+
        '<td class="td_page_view">'+article.view+'</td>'+
        '</tr>'
      });
      $('table.article_list tbody').append(html);
      $('.load').remove()
      return loading.remove();
    });
  }),
  error: function(data){
    $('nav').show()
    return loading.remove();
  }
});
}
});

//검색 상태 표시
if (/search/.exec(window.location.search)) {
  $("form.search").empty().append('<div class="searched_tag">'+decodeURIComponent(window.location.search.split("=")[1])+' 검색됨  <i class="icon icon-remove" aria-hidden="true"></i></div>')
  .click(function(event) {
    window.location = window.location.pathname
  });
}

</script>